<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>音声タイマー</title>
    <script>
      let targetTime, th, tm, ts; // セットした時間、時、分、秒
      let startTime, timer; // 開始時間、タイマー
      let oText = ""; // 直前に発生したテキスト
      const init = () => {
        // ストップボタンの無効化
        document.getElementById("stop").disabled = true;
      };
      const startTimer = () => {
        // セットした時間の取得、読み上げ
        targetTime = document.getElementById("time").value;
        th = Number(targetTime.split(":")[0]);
        tm = Number(targetTime.split(":")[1]);
        ts = Number(targetTime.split(":")[2]);
        if (isNaN(ts)) ts = 0;
        let text = "スタート、残り、";
        if (th > 0) text += `${th}時間`;
        if (tm > 0) text += `${tm}分`;
        if (ts > 0) text += `${ts}秒`;
        text += "です。";
        oText = "";
        speech(text);
        // タイマースタート
        startTime = Date.now();
        timer = setInterval(update, 100);
        // セット時間、スタートボタンの無効化、ストップボタンの有効化
        document.getElementById("time").disabled = true;
        document.getElementById("start").disabled = true;
        document.getElementById("stop").disabled = false;
      };
      const stopTimer = () => {
        // タイマーストップ
        clearInterval(timer);
        // セット時間、スタートボタンの有効化、ストップボタンの無効化
        document.getElementById("time").disabled = false;
        document.getElementById("start").disabled = false;
        document.getElementById("stop").disabled = true;
      };
      const update = () => {
        // 経過時間の取得
        const eTime = Math.floor((Date.now() - startTime) / 1000);
        const eText = getTimeText(eTime);
        // 残り時間の取得
        const rTime = th * 3600 + tm * 60 + ts - eTime;
        const rText = getTimeText(rTime);
        // 経過時間、残り時間の表示
        if (rTime < 0) {
          // 終了
          speech("時間です。");
          stopTimer();
          document.getElementById("eTime").innerText = targetTime;
          document.getElementById("rTime").innerText = "00:00:00";
        } else {
          document.getElementById("eTime").innerText = eText.HMS;
          document.getElementById("rTime").innerText = rText.HMS;
          // 読み上げ
          let text = "";
          const interval = document.getElementById("interval").value;
          if (eTime > 0 && rTime > 10) {
            // 経過
            if (document.getElementById("elapsed").checked) {
              if (eTime % (interval * 60) == 0) {
                text = `${eText.jHM}経過。`;
              }
            }
            // 残り
            if (document.getElementById("remaining").checked) {
              if (rTime % (interval * 60) == 0) {
                text += `残り、${rText.jHM}`;
              }
            }
            if (text != "") speech(text);
          }
          // カウントダウン
          if (document.getElementById("countdown").checked) {
            if (rTime < 11) {
              if (rTime > 0) speech(rTime);
              if (rTime == 0) speech("ゼロ");
            }
          }
        }
      };

      const getTimeText = (time) => {
        // 時間、分、秒の取得
        const h = Math.floor(time / 3600);
        const m = Math.floor((time - h * 3600) / 60);
        const s = Math.floor(time - h * 3600 - m * 60);
        // 「hh:mm:ss」に変換
        const hh = ("00" + h).slice(-2);
        const mm = ("00" + m).slice(-2);
        const ss = ("00" + s).slice(-2);
        const hms = `${hh}:${mm}:${ss}`;
        // 「h時間m分」に変換
        let hm = "";
        if (h > 0) hm += `${h}時間`;
        if (m > 0) hm += `${m}分`;
        return { HMS: hms, jHM: hm };
      };
      const speech = (text) => {
        // 発声
        if (oText != text) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance();
          utterance.text = text;
          utterance.lang = "ja-JP";
          window.speechSynthesis.speak(utterance);
          oText = text;
        }
      };
    </script>
    <style>
      input[type="number"] {
        width: 35px;
      }
      span {
        vertical-align: top;
        font: bold 80px sans-serif;
      }
      .blue {
        color: #0000cc;
      }
      .red {
        color: #cc0000;
      }
    </style>
  </head>
  <body onload="init()">
    <p>音声タイマー</p>
    <input type="time" id="time" value="00:30:00" step="1" />
    <input type="button" id="start" value="スタート" onclick="startTimer()" />
    <input type="button" id="stop" value="ストップ" onclick="stopTimer()" />
    <hr />
    読み上げ間隔：<input
      type="number"
      id="interval"
      value="5"
      min="1"
      max="60"
    />
    分
    <input type="checkbox" id="elapsed" checked />経過時間
    <input type="checkbox" id="remaining" checked />残り時間
    <input type="checkbox" id="countdown" checked />10秒前カウントダウン
    <hr />
    <div class="blue">経過時間 <span id="eTime">00:00:00</span></div>
    <div class="red">残り時間 <span id="rTime">00:00:00</span></div>
  </body>
</html>
